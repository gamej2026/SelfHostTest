name: Deploy to GitHub Pages

on:
  push:
    branches: [main, copilot/deploy-github-pages]
  workflow_dispatch:

# GitHub Pages 배포를 위한 권한 설정
permissions:
  contents: read
  pages: write
  id-token: write

# 동시에 하나의 배포만 허용
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: self-hosted
    steps:
      # 1. 저장소 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      # 2. Unity 라이브러리 캐시
      - name: Cache Unity Library
        uses: actions/cache@v3
        with:
          path: Library
          key: Library-WebGL-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-WebGL-
            Library-

      # 3. Unity 라이센스 확인 및 활성화 (PowerShell 스크립트 사용)
      - name: Check and Activate Unity License
        shell: powershell -ExecutionPolicy Bypass -File {0}
        env:
          UNITY_PATH: ${{ vars.UNITY_PATH }}
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        run: |
          # Unity 설치 경로 찾기
          $unityPath = $env:UNITY_PATH
          
          if (-not $unityPath) {
            # Unity Hub에서 자동 검색
            $hubPath = "C:\Program Files\Unity\Hub\Editor"
            if (Test-Path $hubPath) {
              $unityPath = Get-ChildItem -Path $hubPath -Directory | 
                           Where-Object { $_.Name -match "^\d+\.\d+\.\d+f\d+" } | 
                           Sort-Object Name -Descending | 
                           Select-Object -First 1 | 
                           ForEach-Object { Join-Path $_.FullName "Editor\Unity.exe" }
            }
            
            # 대체 경로 확인
            if (-not $unityPath -or -not (Test-Path $unityPath)) {
              $altPaths = @(
                "D:\UnityEditor\6000.3.4f1\Editor\Unity.exe",
                "D:\Program Files\Unity\Hub\Editor\*\Editor\Unity.exe",
                "C:\Program Files\Unity\Editor\Unity.exe"
              )
              foreach ($path in $altPaths) {
                if ($path -like "*\*\*") {
                  $found = Get-ChildItem -Path $path -ErrorAction SilentlyContinue | Select-Object -First 1
                  if ($found) {
                    $unityPath = $found.FullName
                    break
                  }
                } elseif (Test-Path $path) {
                  $unityPath = $path
                  break
                }
              }
            }
          }
          
          if (-not $unityPath -or -not (Test-Path $unityPath)) {
            Write-Error "Unity를 찾을 수 없습니다. UNITY_PATH 환경변수를 설정하거나 Unity를 설치해주세요."
            exit 1
          }
          
          Write-Host "Unity 경로: $unityPath"
          
          # Unity 라이센스 파일 확인
          $unityLicenseContent = $env:UNITY_LICENSE
          
          if ($unityLicenseContent) {
            Write-Host "Unity 라이센스 파일을 설정합니다..."
            
            # Unity 라이센스 파일 경로 (Windows)
            $licensePath = "$env:ProgramData\Unity\Unity_lic.ulf"
            $licenseDir = Split-Path $licensePath -Parent
            
            # 디렉토리가 없으면 생성
            if (-not (Test-Path $licenseDir)) {
              New-Item -Path $licenseDir -ItemType Directory -Force | Out-Null
            }
            
            # 라이센스 파일 저장
            $unityLicenseContent | Set-Content -Path $licensePath -Encoding UTF8
            Write-Host "Unity 라이센스 파일이 저장되었습니다: $licensePath"
          } else {
            Write-Host "UNITY_LICENSE 시크릿이 설정되지 않았습니다. 기존 라이센스를 사용합니다."
            Write-Host "참고: Self-hosted runner에서 Unity를 수동으로 활성화했거나, 유효한 라이센스 파일이 이미 존재해야 합니다."
          }
          
          # 라이센스 상태 확인 (간단한 테스트)
          Write-Host "`n라이센스 상태를 확인합니다..."
          $testLogFile = Join-Path $PWD.Path "license-test.log"
          
          $process = Start-Process -FilePath $unityPath `
            -ArgumentList "-batchmode", "-nographics", "-quit", "-logFile", $testLogFile `
            -Wait -PassThru -NoNewWindow
          
          # 로그 확인
          if (Test-Path $testLogFile) {
            $logContent = Get-Content $testLogFile -Raw
            
            # 라이센스 오류 확인
            if ($logContent -match "No valid Unity Editor license found" -or $logContent -match "license.*not found") {
              Write-Host "`n=== License Test Log ===`n"
              Get-Content $testLogFile | Select-Object -Last 30
              Write-Warning @"

Unity 라이센스가 활성화되지 않았습니다.
Self-hosted runner에서 다음 중 하나를 수행해야 합니다:
1. Unity를 열고 수동으로 로그인하여 라이센스 활성화
2. 유효한 Unity 라이센스 파일(.ulf)을 GitHub Secrets에 UNITY_LICENSE로 추가

라이센스 파일 가져오기 방법:
- Unity Editor를 열고 Help > Manage License > Manual Activation
- 또는 이미 활성화된 경우: C:\ProgramData\Unity\Unity_lic.ulf 파일 사용
"@
            } else {
              Write-Host "Unity 라이센스가 정상적으로 확인되었습니다."
            }
          }

      # 4. Unity 빌드 실행 (직접 Unity CLI 사용)
      - name: Build Unity WebGL
        shell: powershell -ExecutionPolicy Bypass -File {0}
        env:
          UNITY_PATH: ${{ vars.UNITY_PATH }}
        run: |
          # Unity 설치 경로 찾기
          $unityPath = $env:UNITY_PATH
          
          if (-not $unityPath) {
            # Unity Hub에서 자동 검색
            $hubPath = "C:\Program Files\Unity\Hub\Editor"
            if (Test-Path $hubPath) {
              $unityPath = Get-ChildItem -Path $hubPath -Directory | 
                           Where-Object { $_.Name -match "^\d+\.\d+\.\d+f\d+" } | 
                           Sort-Object Name -Descending | 
                           Select-Object -First 1 | 
                           ForEach-Object { Join-Path $_.FullName "Editor\Unity.exe" }
            }
            
            # 대체 경로 확인
            if (-not $unityPath -or -not (Test-Path $unityPath)) {
              $altPaths = @(
                "D:\UnityEditor\6000.3.4f1\Editor\Unity.exe",
                "D:\Program Files\Unity\Hub\Editor\*\Editor\Unity.exe",
                "C:\Program Files\Unity\Editor\Unity.exe"
              )
              foreach ($path in $altPaths) {
                if ($path -like "*\*\*") {
                  $found = Get-ChildItem -Path $path -ErrorAction SilentlyContinue | Select-Object -First 1
                  if ($found) {
                    $unityPath = $found.FullName
                    break
                  }
                } elseif (Test-Path $path) {
                  $unityPath = $path
                  break
                }
              }
            }
          }
          
          if (-not $unityPath -or -not (Test-Path $unityPath)) {
            Write-Error "Unity를 찾을 수 없습니다. UNITY_PATH 환경변수를 설정하거나 Unity를 설치해주세요."
            exit 1
          }
          
          Write-Host "Unity 경로: $unityPath"
          
          # Unity 빌드 실행
          $projectPath = $PWD.Path
          $logFile = Join-Path $projectPath "build.log"
          
          # Start-Process를 사용하여 프로세스를 실행하고 종료 코드를 캡처
          # 참고: -batchmode와 -nographics는 앞쪽에 배치하여 Unity가 올바르게 batch mode로 실행되도록 합니다
          $process = Start-Process -FilePath $unityPath `
            -ArgumentList "-batchmode", "-nographics", "-quit", "-projectPath", $projectPath, "-buildTarget", "WebGL", "-executeMethod", "BuildScript.BuildWebGL", "-noUpm", "-logFile", $logFile `
            -Wait -PassThru -NoNewWindow
          
          $exitCode = $process.ExitCode
          
          # 로그 출력
          if (Test-Path $logFile) {
            Write-Host "`n=== Unity Build Log ===`n"
            Get-Content $logFile | Select-Object -Last 100
          }
          
          # 빌드 결과 확인
          if ($exitCode -ne 0) {
            Write-Error "Unity 빌드 실패 (Exit Code: $exitCode)"
            exit $exitCode
          }
          
          Write-Host "Unity 빌드 성공!"

      # 5. Gzip 압축 파일 해제 (GitHub Pages 호환성)
      - name: Decompress build files
        shell: powershell -ExecutionPolicy Bypass -File {0}
        run: |
          $buildDir = "build\webgl\Build"
          if (Test-Path $buildDir) {
            Get-ChildItem -Path $buildDir -Filter *.gz | ForEach-Object {
              $outFile = $_.FullName -replace '\.gz$', ''
              Write-Host "Decompressing: $($_.Name)"
              
              # PowerShell을 사용한 Gzip 압축 해제 (리소스 자동 정리)
              try {
                $input = New-Object System.IO.FileStream $_.FullName, ([IO.FileMode]::Open), ([IO.FileAccess]::Read), ([IO.FileShare]::Read)
                try {
                  $output = New-Object System.IO.FileStream $outFile, ([IO.FileMode]::Create), ([IO.FileAccess]::Write), ([IO.FileShare]::None)
                  try {
                    $gzipStream = New-Object System.IO.Compression.GzipStream $input, ([IO.Compression.CompressionMode]::Decompress)
                    try {
                      $buffer = New-Object byte[](1024)
                      while ($true) {
                        $read = $gzipStream.Read($buffer, 0, 1024)
                        if ($read -le 0) { break }
                        $output.Write($buffer, 0, $read)
                      }
                    } finally {
                      $gzipStream.Close()
                    }
                  } finally {
                    $output.Close()
                  }
                } finally {
                  $input.Close()
                }
                Write-Host "Decompressed: $($_.Name)"
              } catch {
                Write-Error "압축 해제 실패: $($_.Name) - $_"
              }
            }
            
            # index.html에서 .gz 확장자 제거
            $indexFile = "build\webgl\index.html"
            if (Test-Path $indexFile) {
              (Get-Content $indexFile) -replace '\.gz"', '"' | Set-Content $indexFile
              Write-Host "Updated index.html to reference decompressed files"
            }
          }

      # 6. 빌드 결과물을 아티팩트로 업로드
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: unity-webgl-build
          path: build/webgl

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # 1. 빌드 아티팩트 다운로드
      - name: Download build artifact
        uses: actions/download-artifact@v4.1.3
        with:
          name: unity-webgl-build
          path: build

      # 2. GitHub Pages 설정
      - name: Setup Pages
        uses: actions/configure-pages@v4

      # 3. 빌드 디렉토리를 아티팩트로 업로드
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './build'

      # 4. GitHub Pages에 배포
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
