name: Deploy to GitHub Pages

on:
  push:
    branches: [main, copilot/deploy-github-pages]
  workflow_dispatch:

# GitHub Pages 배포를 위한 권한 설정
permissions:
  contents: read
  pages: write
  id-token: write

# 동시에 하나의 배포만 허용
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: self-hosted
    env:
      UNITY_PATH: D:\UnityEditor\6000.3.4f1\Editor\Unity.exe
    steps:
      # 1. 저장소 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      # 2. Unity 라이브러리 캐시
      - name: Cache Unity Library
        uses: actions/cache@v3
        with:
          path: Library
          key: Library-WebGL-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-WebGL-
            Library-

      # 3. Unity 라이선스 활성화 (Self-hosted runner)
      - name: Activate Unity License
        if: ${{ UNITY_LICENSE || UNITY_EMAIL }}
        shell: cmd
        run: |
          echo Activating Unity license...
          if defined UNITY_LICENSE (
            echo Using license file
            (echo %UNITY_LICENSE%) > unity.ulf 2>nul
            "%UNITY_PATH%" -batchmode -manualLicenseFile unity.ulf -quit -logFile license-activate.log
            del unity.ulf 2>nul
          ) else if defined UNITY_EMAIL (
            echo Using credentials
            "%UNITY_PATH%" -batchmode -username "%UNITY_EMAIL%" -password "%UNITY_PASSWORD%" -serial "%UNITY_SERIAL%" -quit -logFile license-activate.log
          )
          if exist license-activate.log (
            type license-activate.log
          ) else (
            echo No license log generated
          )

      # 4. Unity 빌드 실행 (Self-hosted runner with local Unity installation)
      - name: Build Unity WebGL
        shell: cmd
        run: |
          "%UNITY_PATH%" -quit -batchmode -nographics -projectPath "%CD%" -executeMethod BuildScript.BuildWebGL -logFile build.log
          if %ERRORLEVEL% NEQ 0 (
            type build.log
            exit /b %ERRORLEVEL%
          )

      # 5. Unity 라이선스 반환 (선택적)
      - name: Return Unity License
        if: ${{ always() && UNITY_EMAIL }}
        shell: 
        run: |
          echo Returning Unity license...
          "%UNITY_PATH%" -quit -batchmode -returnlicense -logFile license-return.log
          if exist license-return.log (
            type license-return.log
          ) else (
            echo No return log generated
          )

      # 6. Gzip 압축 파일 해제 (GitHub Pages 호환성)
      - name: Decompress build files
        shell: powershell -ExecutionPolicy RemoteSigned -File {0}
        run: |
          $buildDir = "build\webgl\Build"
          if (Test-Path $buildDir) {
            Get-ChildItem -Path $buildDir -Filter *.gz | ForEach-Object {
              $outFile = $_.FullName -replace '\.gz$', ''
              Write-Host "Decompressing: $($_.Name)"
              
              # PowerShell을 사용한 Gzip 압축 해제
              $input = New-Object System.IO.FileStream $_.FullName, ([IO.FileMode]::Open), ([IO.FileAccess]::Read), ([IO.FileShare]::Read)
              $output = New-Object System.IO.FileStream $outFile, ([IO.FileMode]::Create), ([IO.FileAccess]::Write), ([IO.FileShare]::None)
              $gzipStream = New-Object System.IO.Compression.GzipStream $input, ([IO.Compression.CompressionMode]::Decompress)
              
              $buffer = New-Object byte[](1024)
              while ($true) {
                $read = $gzipStream.Read($buffer, 0, 1024)
                if ($read -le 0) { break }
                $output.Write($buffer, 0, $read)
              }
              
              $gzipStream.Close()
              $output.Close()
              $input.Close()
              
              Write-Host "Decompressed: $($_.Name)"
            }
            
            # index.html에서 .gz 확장자 제거
            $indexFile = "build\webgl\index.html"
            if (Test-Path $indexFile) {
              (Get-Content $indexFile) -replace '\.gz"', '"' | Set-Content $indexFile
              Write-Host "Updated index.html to reference decompressed files"
            }
          }

      # 7. 빌드 결과물을 아티팩트로 업로드
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: unity-webgl-build
          path: build/webgl

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # 1. 빌드 아티팩트 다운로드
      - name: Download build artifact
        uses: actions/download-artifact@v4.1.3
        with:
          name: unity-webgl-build
          path: build

      # 2. GitHub Pages 설정
      - name: Setup Pages
        uses: actions/configure-pages@v4

      # 3. 빌드 디렉토리를 아티팩트로 업로드
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './build'

      # 4. GitHub Pages에 배포
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
